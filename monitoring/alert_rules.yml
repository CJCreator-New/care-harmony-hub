groups:
  - name: caresync-alerts
    rules:
    # Service Health Alerts
    - alert: ServiceDown
      expr: up == 0
      for: 5m
      labels:
        severity: critical
      annotations:
        summary: "Service {{ $labels.job }} is down"
        description: "Service {{ $labels.job }} has been down for more than 5 minutes."
        runbook_url: "https://caresync.com/runbooks/service-down"

    # API Gateway Alerts
    - alert: KongHighErrorRate
      expr: rate(kong_http_requests_total{status=~"5.."}[5m]) / rate(kong_http_requests_total[5m]) > 0.05
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "Kong API Gateway high error rate"
        description: "Kong API Gateway error rate is {{ $value | humanizePercentage }} over the last 5 minutes."

    - alert: KongHighLatency
      expr: histogram_quantile(0.95, rate(kong_latency_bucket[5m])) > 5
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "Kong API Gateway high latency"
        description: "Kong API Gateway 95th percentile latency is {{ $value }}s over the last 5 minutes."

    # Microservice Alerts
    - alert: MicroserviceHighErrorRate
      expr: rate(http_requests_total{status=~"5.."}[5m]) / rate(http_requests_total[5m]) > 0.05
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "Microservice {{ $labels.service }} high error rate"
        description: "Service {{ $labels.service }} error rate is {{ $value | humanizePercentage }} over the last 5 minutes."

    - alert: MicroserviceHighLatency
      expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 2
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "Microservice {{ $labels.service }} high latency"
        description: "Service {{ $labels.service }} 95th percentile latency is {{ $value }}s over the last 5 minutes."

    # Database Alerts
    - alert: DatabaseConnectionHigh
      expr: rate(postgres_connections_active[5m]) > 80
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "Database high connection count"
        description: "Database {{ $labels.dbname }} has {{ $value }} active connections."

    - alert: DatabaseSlowQueries
      expr: rate(postgres_query_duration_seconds_count[5m]) > 100
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "Database slow queries"
        description: "Database {{ $labels.dbname }} has high slow query rate."

    # Cache Alerts
    - alert: RedisHighMemoryUsage
      expr: redis_memory_used_bytes / redis_memory_max_bytes > 0.8
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "Redis high memory usage"
        description: "Redis memory usage is {{ $value | humanizePercentage }}."

    - alert: RedisHighConnectionCount
      expr: redis_connected_clients > 100
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "Redis high connection count"
        description: "Redis has {{ $value }} connected clients."

    # Message Queue Alerts
    - alert: KafkaHighLag
      expr: kafka_consumergroup_lag > 1000
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "Kafka consumer group high lag"
        description: "Consumer group {{ $labels.consumergroup }} has lag of {{ $value }} messages."

    # Container Resource Alerts
    - alert: HighCPUUsage
      expr: rate(container_cpu_usage_seconds_total[5m]) > 0.8
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "Container high CPU usage"
        description: "Container {{ $labels.container }} CPU usage is {{ $value | humanizePercentage }}."

    - alert: HighMemoryUsage
      expr: container_memory_usage_bytes / container_spec_memory_limit_bytes > 0.8
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "Container high memory usage"
        description: "Container {{ $labels.container }} memory usage is {{ $value | humanizePercentage }}."

    # Disk Space Alerts
    - alert: LowDiskSpace
      expr: (1 - node_filesystem_avail_bytes / node_filesystem_size_bytes) > 0.8
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "Low disk space"
        description: "Disk space on {{ $labels.device }} is {{ $value | humanizePercentage }} used."